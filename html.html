<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Staff Visualizer (Range: C1 - C6)</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        #toggleBtn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s, background-color 0.2s;
            width: 100%;
        }

        #toggleBtn:hover { transform: scale(1.02); background-color: #0056b3; }
        #toggleBtn.stop { background-color: #dc3545; }

        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
            text-align: left;
            background: #3d3d3d;
            padding: 15px;
            border-radius: 10px;
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
            margin-top: 5px;
            cursor: pointer;
        }

        input[type=range] { width: 100%; cursor: pointer; margin-top: 10px; }
        label { display: flex; justify-content: space-between; font-weight: bold; color: #ddd; }

        canvas {
            background-color: #fff; /* Paper white for sheet music */
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
            display: block;
        }

        #waveCanvas { background-color: #000; border: 1px solid #555; }
        
        .note-display {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #4db8ff;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="note-display" id="noteDisplay">--</div>
        
        <canvas id="staffCanvas" width="800" height="300"></canvas>
        <canvas id="waveCanvas" width="800" height="150"></canvas>

        <div class="controls">
            <div style="grid-column: 1 / -1;">
                <label for="waveType">Waveform Type</label>
                <select id="waveType">
                    <option value="sine">Sine Wave (Pure)</option>
                    <option value="triangle">Triangle Wave (Clarinet-ish)</option>
                    <option value="square">Square Wave (Game Boy)</option>
                    <option value="sawtooth">Sawtooth Wave (Brass-ish)</option>
                </select>
            </div>

            <div>
                <label>Frequency: <span id="freqLabel">440 Hz</span></label>
                <input type="range" id="freqSlider" min="32" max="1047" value="440" step="1">
            </div>
            <div>
                <label>Amplitude</label>
                <input type="range" id="ampSlider" min="0" max="0.2" step="0.01" value="0.1">
            </div>
        </div>

        <button id="toggleBtn">CLICK TO START SOUND</button>
    </div>

    <script>
        // --- AUDIO SETUP ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let oscillator;
        let gainNode;
        let isPlaying = false;

        const freqSlider = document.getElementById('freqSlider');
        const ampSlider = document.getElementById('ampSlider');
        const waveTypeSelect = document.getElementById('waveType');
        const freqLabel = document.getElementById('freqLabel');
        const noteDisplay = document.getElementById('noteDisplay');
        const toggleBtn = document.getElementById('toggleBtn');

        const waveCanvas = document.getElementById('waveCanvas');
        const waveCtx = waveCanvas.getContext('2d');
        const staffCanvas = document.getElementById('staffCanvas');
        const staffCtx = staffCanvas.getContext('2d');

        const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            oscillator = audioCtx.createOscillator();
            gainNode = audioCtx.createGain();

            oscillator.type = waveTypeSelect.value;
            oscillator.frequency.value = freqSlider.value;
            gainNode.gain.value = ampSlider.value;

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
        }

        function toggleSound() {
            if (!isPlaying) {
                initAudio();
                isPlaying = true;
                toggleBtn.textContent = "STOP SOUND";
                toggleBtn.classList.add("stop");
            } else {
                oscillator.stop();
                oscillator.disconnect();
                isPlaying = false;
                toggleBtn.textContent = "START SOUND";
                toggleBtn.classList.remove("stop");
            }
        }

        waveTypeSelect.addEventListener('change', () => {
            if(isPlaying && oscillator) oscillator.type = waveTypeSelect.value;
        });

        // --- VISUALIZATION LOOP ---
        let phase = 0;

        function draw() {
            requestAnimationFrame(draw);

            const freq = parseFloat(freqSlider.value);
            const amp = parseFloat(ampSlider.value);
            const type = waveTypeSelect.value;
            
            // 1. Draw Waveform
            drawOscilloscope(freq, amp, type);

            // 2. Draw Grand Staff
            drawGrandStaff(freq);
        }

        function drawOscilloscope(freq, amp, type) {
            const w = waveCanvas.width;
            const h = waveCanvas.height;
            const centerY = h / 2;

            waveCtx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
            waveCtx.fillRect(0, 0, w, h);
            
            // Dynamic Color
            if (type === 'sine') waveCtx.strokeStyle = '#00ff00';
            else if (type === 'square') waveCtx.strokeStyle = '#ff00ff'; 
            else if (type === 'triangle') waveCtx.strokeStyle = '#00ffff'; 
            else waveCtx.strokeStyle = '#ffaa00'; 

            waveCtx.lineWidth = 3;
            waveCtx.beginPath();

            // Adjusted visual frequency for the C6 range
            const visualFreq = freq * 0.05; 
            const visualAmp = amp * 400; 

            for (let x = 0; x < w; x++) {
                const angle = (x * visualFreq * (Math.PI / 180)) + phase;
                let sample = 0;

                switch (type) {
                    case 'sine': sample = Math.sin(angle); break;
                    case 'square': sample = Math.sign(Math.sin(angle)); break;
                    case 'triangle': sample = (2 / Math.PI) * Math.asin(Math.sin(angle)); break;
                    case 'sawtooth': sample = -1 * (2 * (angle / (2 * Math.PI) - Math.floor(0.5 + angle / (2 * Math.PI)))); break;
                }
                const y = centerY + (sample * visualAmp);
                if (x === 0) waveCtx.moveTo(x, y);
                else waveCtx.lineTo(x, y);
            }
            waveCtx.stroke();
            phase -= freq * 0.05;
        }

        // --- MUSIC THEORY ENGINE ---

        // Helper: Convert MIDI note to "White Key Steps" from C0
        function getScaleStep(midiNote) {
            const octave = Math.floor(midiNote / 12) - 1;
            const noteIndex = midiNote % 12;
            // Map 0-11 to 0-6 (ignoring accidentals for height)
            const map = [0,0,1,1,2,3,3,4,4,5,5,6];
            return (octave * 7) + map[noteIndex];
        }

        function drawGrandStaff(freq) {
            const w = staffCanvas.width;
            const h = staffCanvas.height;
            const ctx = staffCtx;
            
            // Clear
            ctx.clearRect(0, 0, w, h);

            // 1. Calculations
            const A4 = 440;
            const semitones = 12 * (Math.log(freq / A4) / Math.log(2));
            const midiNote = Math.round(semitones) + 69;
            const noteIndex = midiNote % 12;
            const octave = Math.floor(midiNote / 12) - 1;
            const noteName = NOTE_NAMES[noteIndex];
            
            // Update UI Text
            noteDisplay.textContent = `${noteName}${octave}`;
            freqLabel.textContent = `${Math.round(freq)} Hz`;

            // 2. Setup Dimensions
            const spacing = 14; // space between lines
            const trebleTopY = 60; // F5
            const bassTopY = 180;  // A3
            
            // Draw Staff Lines
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 1;
            ctx.beginPath();

            // Treble Staff (5 lines)
            for(let i=0; i<5; i++) {
                let y = trebleTopY + (i*spacing);
                ctx.moveTo(50, y); ctx.lineTo(w-50, y);
            }
            // Bass Staff (5 lines)
            for(let i=0; i<5; i++) {
                let y = bassTopY + (i*spacing);
                ctx.moveTo(50, y); ctx.lineTo(w-50, y);
            }
            ctx.stroke();

            // Draw Grand Staff Brace (Left side)
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.moveTo(50, trebleTopY);
            ctx.lineTo(50, bassTopY + (4*spacing));
            ctx.stroke();

            // Draw Clefs
            ctx.fillStyle = "black";
            
            // Treble Clef
            ctx.font = "65px serif";
            ctx.fillText("ð„ž", 55, trebleTopY + (3.5*spacing)); 

            // Bass Clef
            ctx.font = "55px serif";
            ctx.fillText("ð„¢", 55, bassTopY + (2.8*spacing));


            // 3. Determine Position
            // Middle C (C4, MIDI 60) is our pivot
            // Logic: Note >= 60 (Middle C) -> Draw on Treble
            // Logic: Note < 60  -> Draw on Bass
            
            let referenceY, isTreble;

            if (midiNote >= 60) {
                // Treble Logic
                isTreble = true;
                // Reference: B4 (MIDI 71) is the center line of Treble Staff
                const B4 = 71; 
                const midLineY = trebleTopY + (2*spacing);
                
                const stepDiff = getScaleStep(B4) - getScaleStep(midiNote);
                referenceY = midLineY + (stepDiff * (spacing/2));
            } else {
                // Bass Logic
                isTreble = false;
                // Reference: D3 (MIDI 50) is the center line of Bass Staff
                const D3 = 50; 
                const midLineY = bassTopY + (2*spacing);
                
                const stepDiff = getScaleStep(D3) - getScaleStep(midiNote);
                referenceY = midLineY + (stepDiff * (spacing/2));
            }

            const noteY = referenceY;

            // 4. Draw Ledger Lines
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            
            // Treble Boundaries
            const trebleBottomLine = trebleTopY + (4*spacing); // E4
            const trebleTopLine = trebleTopY; // F5
            
            // Bass Boundaries
            const bassBottomLine = bassTopY + (4*spacing); // G2
            const bassTopLine = bassTopY; // A3

            function drawLedger(yPos) {
                ctx.beginPath();
                ctx.moveTo(w/2 - 20, yPos);
                ctx.lineTo(w/2 + 20, yPos);
                ctx.stroke();
            }

            if (isTreble) {
                // If y > bottom line (Note is lower than E4)
                if (noteY > trebleBottomLine + (spacing/4)) {
                    for (let ly = trebleBottomLine + spacing; ly <= noteY + 1; ly += spacing) {
                        drawLedger(ly);
                    }
                }
                // If y < top line (Note is higher than F5)
                if (noteY < trebleTopLine - (spacing/4)) {
                    for (let ly = trebleTopLine - spacing; ly >= noteY - 1; ly -= spacing) {
                        drawLedger(ly);
                    }
                }
            } else {
                // If y < top line (Note is higher than A3)
                if (noteY < bassTopLine - (spacing/4)) {
                    for (let ly = bassTopLine - spacing; ly >= noteY - 1; ly -= spacing) {
                        drawLedger(ly);
                    }
                }
                // If y > bottom line (Note is lower than G2)
                if (noteY > bassBottomLine + (spacing/4)) {
                    for (let ly = bassBottomLine + spacing; ly <= noteY + 1; ly += spacing) {
                        drawLedger(ly);
                    }
                }
            }

            // 5. Draw Note Head
            ctx.beginPath();
            ctx.ellipse(w/2, noteY, 11, 9, 0, 0, 2*Math.PI);
            ctx.fillStyle = "black";
            ctx.fill();

            // 6. Draw Stem
            ctx.beginPath();
            ctx.lineWidth = 2;
            
            // Treble Mid = B4 (71), Bass Mid = D3 (50)
            const pivotMidi = isTreble ? 71 : 50;
            
            if (midiNote < pivotMidi) {
                // Stem Up (Right side)
                ctx.moveTo(w/2 + 10, noteY);
                ctx.lineTo(w/2 + 10, noteY - 45);
            } else {
                // Stem Down (Left side)
                ctx.moveTo(w/2 - 10, noteY);
                ctx.lineTo(w/2 - 10, noteY + 45);
            }
            ctx.stroke();

            // 7. Sharp/Flat
            if(noteName.includes("#")) {
                ctx.font = "24px serif";
                ctx.fillText("â™¯", w/2 - 35, noteY + 10);
            }
        }

        // --- LISTENERS ---
        toggleBtn.addEventListener('click', toggleSound);

        freqSlider.addEventListener('input', () => {
            if(isPlaying) oscillator.frequency.value = freqSlider.value;
        });
        
        ampSlider.addEventListener('input', () => {
            if(isPlaying) gainNode.gain.value = ampSlider.value;
        });

        draw();

    </script>
</body>
</html>

